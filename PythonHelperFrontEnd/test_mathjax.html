<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathJax LaTeX渲染测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .test-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .message-content {
            padding: 15px 20px;
            border-radius: 28px;
            font-size: 14px;
            line-height: 1.5;
            background-color: #ffffff;
            color: #333;
            border: 1px solid #e0e0e0;
            margin: 10px 0;
        }
        
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
    
    <!-- MathJax CDN -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                ready: () => {
                    console.log('MathJax已加载并准备就绪');
                    window.MathJax.startup.defaultReady();
                    document.getElementById('mathjax-status').innerHTML = '<span class="success">✓ MathJax已加载完成</span>';
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <h1>MathJax LaTeX渲染测试</h1>
    
    <div class="test-container">
        <div class="test-title">MathJax状态：</div>
        <div id="mathjax-status" class="loading">⏳ 正在加载MathJax...</div>
    </div>
    
    <div class="test-container">
        <div class="test-title">LaTeX渲染测试：</div>
        <div class="message-content" id="testContent">
            <!-- 这里会显示测试内容 -->
        </div>
    </div>
    
    <div class="test-container">
        <button onclick="testBasicLatex()">测试基础LaTeX</button>
        <button onclick="testComplexLatex()">测试复杂LaTeX</button>
        <button onclick="testMixedContent()">测试混合内容</button>
        <button onclick="clearTest()">清空测试</button>
    </div>

    <script>
        // 模拟UIManager的格式化方法
        function formatMessageContent(content) {
            if (!content) return '';

            const latexPlaceholders = [];
            const placeholder = "LATEX_PLACEHOLDER_";

            // 1. 保护LaTeX公式块，用占位符替换
            let tempContent = content.replace(/\$\$([\s\S]*?)\$\$/g, (match) => {
                latexPlaceholders.push(match);
                return `${placeholder}${latexPlaceholders.length - 1}`;
            });
            tempContent = tempContent.replace(/\$([^$]*?)\$/g, (match) => {
                latexPlaceholders.push(match);
                return `${placeholder}${latexPlaceholders.length - 1}`;
            });

            // 2. 处理换行
            let formattedContent = tempContent.replace(/\n{2,}/g, '\n');
            formattedContent = formattedContent.replace(/\n/g, '<br>');
            formattedContent = `<p>${formattedContent}</p>`;
            formattedContent = formattedContent
                .replace(/\s*<br>\s*<br>\s*/g, '<br>')
                .replace(/<br>\s*<br>\s*<br>/g, '<br>')
                .replace(/^\s*<br>\s*/g, '')
                .replace(/\s*<br>\s*$/g, '');

            // 3. 恢复LaTeX公式，让MathJax处理渲染
            formattedContent = formattedContent.replace(new RegExp(`${placeholder}(\\d+)`, 'g'), (match, index) => {
                return latexPlaceholders[parseInt(index, 10)];
            });
            
            return formattedContent;
        }
        
        // 模拟UIManager的渲染方法
        function renderMathInElement(element) {
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([element]).catch((err) =>
                        console.log('MathJax typesetting error:', err)
                    );
                } else if (window.MathJax && window.MathJax.Hub) {
                    window.MathJax.Hub.Queue(["Typeset", window.MathJax.Hub, element]);
                } else {
                    console.warn('MathJax not loaded, waiting for it to be available...');
                    setTimeout(() => {
                        renderMathInElement(element);
                    }, 100);
                }
            }, 10);
        }
        
        function testBasicLatex() {
            const testText = `这是一个简单的数学公式：$x^2 + y^2 = z^2$

希腊字母测试：$\\alpha + \\beta = \\gamma$

积分公式：$\\int_0^1 x^2 dx = \\frac{1}{3}$

块级公式：
$$\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}$$

混合内容：文本 $a^2 + b^2 = c^2$ 和更多文本`;

            const content = document.getElementById('testContent');
            content.innerHTML = formatMessageContent(testText);
            renderMathInElement(content);
        }
        
        function testComplexLatex() {
            const complexText = `复杂公式测试：

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

矩阵：
$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}$$

分数：
$$\\frac{\\partial f}{\\partial x} = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$

求和：
$$\\sum_{i=1}^{n} \\frac{1}{i^2} = \\frac{\\pi^2}{6}$$

行内复杂公式：$\\sqrt{x^2 + y^2} = \\sqrt{\\sum_{i=1}^{n} x_i^2}$`;

            const content = document.getElementById('testContent');
            content.innerHTML = formatMessageContent(complexText);
            renderMathInElement(content);
        }
        
        function testMixedContent() {
            const mixedText = `这是一个包含多种内容的测试：

**知识点：**
- 点阵图存储的基本原理：每个像素点用1位（bit）表示
- 存储空间的计算公式：总存储空间 = 汉字数量 × 每个汉字的点阵大小

**计算过程：**
1. 每个汉字占用：$16 \\times 16 = 256$ 位
2. 总存储空间（位）：$10,000 \\times 256 = 2,560,000$ 位
3. 总存储空间（字节）：$\\frac{2,560,000}{8} = 320,000$ 字节
4. 总存储空间（KB）：$\\frac{320,000}{1024} \\approx 312.5$ KB

**最终公式：**
$$\\text{存储空间(KB)} = \\frac{\\text{汉字数量} \\times \\text{点阵大小(位)}}{8 \\times 1024}$$`;

            const content = document.getElementById('testContent');
            content.innerHTML = formatMessageContent(mixedText);
            renderMathInElement(content);
        }
        
        function clearTest() {
            document.getElementById('testContent').innerHTML = '';
        }
        
        // 页面加载完成后自动测试
        window.addEventListener('load', () => {
            setTimeout(() => {
                testBasicLatex();
            }, 1000);
        });
    </script>
</body>
</html>
